# Overview

TL;DR A Google Cloud Fuction written in Python that forwards un-authenticated sensor data to PubSub. The sensor data is generated by EccoWitt devices _(see more here: https://www.ecowitt.com/shop/homePage)_

# Setup

This project includes a .yaml file for deployment to Google Cloud using Github Actions maintained here: https://github.com/google-github-actions/deploy-cloud-functions. The Github Action Workflow requires several _"Action Secrets"_ used to set environment variables during deployment. Set the following secrets in the repository before deployment.

| Action Secret  | Value                                                          |
| -------------- | -------------------------------------------------------------- |
| GCP_PROJECT_ID | GCP Project ID where Function will be deployed                 |
| GCP_SA_KEY     | Service Account Key used to authenticate GitHub to GCP Project |
| TOPIC_NAME     | Destination PubSub Topic name                                  |

# PubSub Setup

Avro Schema Definition

```json
{
  "type": "record",
  "name": "avro",
  "fields": [
    {
      "name": "stationtype",
      "type": "string"
    },
    {
      "name": "eventtime",
      "type": "string"
    },
    {
      "name": "processingtime",
      "type": "string"
    },
    {
      "name": "tempinf",
      "type": "float"
    },
    {
      "name": "humidityin",
      "type": "double"
    },
    {
      "name": "aromrelin",
      "type": "float"
    },
    {
      "name": "aromasin",
      "type": "float"
    },
    {
      "name": "freq",
      "type": "string"
    },
    {
      "name": "model",
      "type": "string"
    },
    {
      "name": "soilsensors",
      "type": {
        "name": "soilsensors",
        "type": "record",
        "fields": [
          {
            "name": "soilmoisture1",
            "type": "double"
          },
          {
            "name": "soilatt1",
            "type": "float"
          },
          {
            "name": "soilmoisture2",
            "type": "double"
          },
          {
            "name": "soilatt2",
            "type": "float"
          },
          {
            "name": "soilmoisture3",
            "type": "double"
          },
          {
            "name": "soilatt3",
            "type": "float"
          }
        ]
      }
    },
    {
      "name": "id",
      "type": "string"
    }
  ]
}
```

# BigQuery Setup

```json
[
  {
    "mode": "NULLABLE",
    "name": "stationtype",
    "type": "STRING"
  },
  {
    "mode": "NULLABLE",
    "name": "eventtime",
    "type": "STRING"
  },
  {
    "mode": "NULLABLE",
    "name": "processingtime",
    "type": "STRING"
  },
  {
    "mode": "NULLABLE",
    "name": "tempinf",
    "type": "FLOAT"
  },
  {
    "mode": "NULLABLE",
    "name": "humidityin",
    "type": "FLOAT"
  },
  {
    "mode": "NULLABLE",
    "name": "aromrelin",
    "type": "FLOAT"
  },
  {
    "mode": "NULLABLE",
    "name": "aromasin",
    "type": "FLOAT"
  },
  {
    "mode": "NULLABLE",
    "name": "freq",
    "type": "STRING"
  },
  {
    "mode": "NULLABLE",
    "name": "model",
    "type": "STRING"
  },
  {
    "fields": [
      { "mode": "NULLABLE", "name": "soilmoisture1", "type": "FLOAT" },
      { "mode": "NULLABLE", "name": "soilatt1", "type": "FLOAT" },
      { "mode": "NULLABLE", "name": "soilmoisture2", "type": "FLOAT" },
      { "mode": "NULLABLE", "name": "soilatt2", "type": "FLOAT" },
      { "mode": "NULLABLE", "name": "soilmoisture3", "type": "FLOAT" },
      { "mode": "NULLABLE", "name": "soilatt3", "type": "FLOAT" }
    ],
    "name": "soilsensors",
    "type": "RECORD"
  },
  {
    "mode": "NULLABLE",
    "name": "id",
    "type": "STRING"
  }
]
```
